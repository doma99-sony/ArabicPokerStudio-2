import { useState, useEffect } from "react";
import { useLocation } from "wouter";
import { useAuth } from "@/hooks/use-auth";
import { Button } from "@/components/ui/button";
import { 
  ArrowLeft, 
  DollarSign, 
  Home, 
  Crown,
  ShoppingCart,
  ShoppingBag,
  Trophy
} from "lucide-react";

// ุงุณุชูุฑุงุฏ ุงูููููุงุช ูุงูููู
import EgyptRocket from "./components/rocket";
import PlayersList from "./components/players-list";
import GameHistoryComponent from "./components/game-history";
import BettingControls from "./components/betting-controls";
import { useEgyptRocketSocket } from "./hooks/use-egypt-rocket-socket";

// ุตูุญุฉ ูุนุจุฉ ุตุงุฑูุฎ ูุตุฑ
const EgyptRocketPage = () => {
  const { user } = useAuth();
  const [, navigate] = useLocation();
  const [isBetPlaced, setIsBetPlaced] = useState<boolean>(false);
  const [isCashedOut, setIsCashedOut] = useState<boolean>(false);

  // ุงุณุชุฎุฏุงู ููู ุงูุงุชุตุงู ุจุงูุฎุงุฏู
  const { 
    gameState, 
    placeBet, 
    cashout, 
    isConnected,
    error
  } = useEgyptRocketSocket();

  // ุชุชุจุน ุญุงูุฉ ุงูุฑูุงู ูุงูุณุญุจ ุจูุงุกู ุนูู ุญุงูุฉ ุงููุนุจุฉ
  useEffect(() => {
    // ุฅุฐุง ุชุบูุฑุช ุญุงูุฉ ุงููุนุจุฉ ุฅูู "waiting"ุ ูุฅุนุงุฏุฉ ุชุนููู ุญุงูุฉ ุงูุฑูุงู ูุงูุณุญุจ
    if (gameState.status === 'waiting') {
      setIsBetPlaced(false);
      setIsCashedOut(false);
    }
  }, [gameState.status]);

  // ุงูุชุนุงูู ูุน ูุถุน ุฑูุงู
  const handlePlaceBet = (amount: number, autoCashout: number | null) => {
    if (gameState.status !== 'waiting' || gameState.countdown === 0) {
      return;
    }
    
    if (!user) {
      console.log("ูุฌุจ ุชุณุฌูู ุงูุฏุฎูู ุฃููุงู");
      return;
    }
    
    if (amount <= 0) {
      console.log("ูุจูุบ ุงูุฑูุงู ูุฌุจ ุฃู ูููู ุฃูุจุฑ ูู 0");
      return;
    }
    
    if (user.chips < amount) {
      console.log("ูุง ููุฌุฏ ุฑุตูุฏ ูุงูู");
      return;
    }
    
    // ุฅุฑุณุงู ุงูุฑูุงู ุฅูู ุงูุฎุงุฏู
    placeBet(amount, autoCashout);
    setIsBetPlaced(true);
    
    console.log(`ุชู ูุถุน ุฑูุงู ุจูููุฉ ${amount}`);
  };

  // ุงูุชุนุงูู ูุน ุงูุณุญุจ
  const handleCashout = () => {
    if (gameState.status !== 'flying' || !isBetPlaced || isCashedOut) {
      return;
    }
    
    // ุฅุฑุณุงู ุทูุจ ุณุญุจ ุฅูู ุงูุฎุงุฏู
    cashout();
    setIsCashedOut(true);
    
    console.log(`ุชู ุทูุจ ุงูุณุญุจ`);
  };

  return (
    <div className="bg-gradient-to-b from-sky-900 to-slate-900 min-h-screen pb-16 relative overflow-hidden rtl">
      {/* ุฑุณุงูุฉ ุงูุฎุทุฃ */}
      {error && (
        <div className="fixed inset-0 flex items-center justify-center z-50 bg-black/70">
          <div className="bg-slate-800 p-6 rounded-lg shadow-lg max-w-md">
            <h3 className="text-xl text-red-400 mb-4">ุญุฏุซ ุฎุทุฃ!</h3>
            <p className="text-white mb-6">{error}</p>
            <Button 
              className="w-full bg-red-500 hover:bg-red-600"
              onClick={() => window.location.reload()}
            >
              ุชุญุฏูุซ ุงูุตูุญุฉ
            </Button>
          </div>
        </div>
      )}

      {/* ุดุฑูุท ุงูุชููู ุงูุนููู */}
      <div className="bg-slate-800 p-3 flex justify-between items-center shadow-md">
        <Button 
          variant="ghost" 
          size="icon" 
          className="text-white" 
          onClick={() => navigate("/")}
        >
          <ArrowLeft className="h-6 w-6" />
        </Button>
        <h1 className="text-xl font-bold text-white">ุตุงุฑูุฎ ูุตุฑ ๐</h1>
        <div className="flex items-center gap-2">
          <div className="bg-emerald-600 text-white py-1 px-3 rounded-full text-sm flex items-center">
            <DollarSign className="h-4 w-4 mr-1" />
            <span>{user?.chips || 5000}</span>
          </div>
        </div>
      </div>

      {/* ูุคุดุฑ ุงูุงุชุตุงู */}
      <div className={`
        absolute top-14 left-4 w-3 h-3 rounded-full transition-colors duration-300
        ${isConnected ? 'bg-green-500' : 'bg-red-500'}
      `}></div>

      {/* ููุทูุฉ ุงููุนุจ ุงูุฑุฆูุณูุฉ */}
      <div className="relative h-[50vh] bg-gradient-to-b from-transparent to-slate-900/50 overflow-hidden mt-4">
        {/* ุฎูููุฉ ุงููุฌูู */}
        <div className="absolute inset-0 bg-[radial-gradient(white,_rgba(255,255,255,.2)_2px,_transparent_40px)] bg-[length:50px_50px] z-0"></div>
        
        {/* ุงูุตุงุฑูุฎ ุงููุตุฑู */}
        <EgyptRocket 
          gameStatus={gameState.status} 
          currentMultiplier={gameState.currentMultiplier} 
        />
        
        {/* ุงููุถุงุนู ุงูุญุงูู */}
        <div className="absolute top-10 right-1/2 transform translate-x-1/2 text-center z-10">
          {gameState.currentMultiplier ? (
            <div className="text-4xl font-bold text-yellow-400 drop-shadow-[0_0_10px_rgba(234,179,8,0.7)]">
              {`${gameState.currentMultiplier.toFixed(2)}x`}
            </div>
          ) : gameState.status === 'waiting' ? (
            <div className="text-4xl font-bold text-white">
              {gameState.countdown > 0 ? `${gameState.countdown}` : "ุงูุทูุงู!"}
            </div>
          ) : (
            <div className="text-4xl font-bold text-red-500">
              ุงููุฌุฑ!
            </div>
          )}
        </div>
      </div>

      {/* ููุญุฉ ุงูุชุญูู ูู ุงูุฑูุงู */}
      <div className="bg-slate-800 rounded-t-xl -mt-6 relative z-10 px-4 py-6 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.3)]">
        {/* ุนูุงุตุฑ ุงูุชุญูู ุจุงููุฑุงููุฉ */}
        <BettingControls 
          onPlaceBet={handlePlaceBet}
          onCashout={handleCashout}
          gameStatus={gameState.status}
          isBetPlaced={isBetPlaced}
          isCashedOut={isCashedOut}
          countdown={gameState.countdown}
          userChips={user?.chips || 0}
        />
        
        {/* ุฌุฏูู ุงููุงุนุจูู ูุณุฌู ุงูุฃูุนุงุจ */}
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
          {/* ูุงุฆูุฉ ุงููุงุนุจูู */}
          <PlayersList players={gameState.players} />
          
          {/* ุณุฌู ุงูุฃูุนุงุจ ุงูุณุงุจูุฉ */}
          <GameHistoryComponent history={gameState.gameHistory} />
        </div>
      </div>

      {/* ุดุฑูุท ุงูุชููู ุงูุณููู */}
      <div className="fixed bottom-0 left-0 right-0 bg-slate-800 py-2 px-4 flex justify-around items-center z-20 border-t border-slate-700">
        <button className="flex flex-col items-center text-white py-1" onClick={() => navigate("/")}>
          <Home className="h-6 w-6" />
          <span className="text-xs mt-1">ุงูุฑุฆูุณูุฉ</span>
        </button>
        
        <button className="flex flex-col items-center text-white py-1">
          <Trophy className="h-6 w-6" />
          <span className="text-xs mt-1">ุงูุชุตููู</span>
        </button>
        
        <button className="flex flex-col items-center text-white py-1">
          <ShoppingCart className="h-6 w-6" />
          <span className="text-xs mt-1">ุงููุชุฌุฑ</span>
        </button>
        
        <button className="flex flex-col items-center text-white py-1">
          <ShoppingBag className="h-6 w-6" />
          <span className="text-xs mt-1">ุงููุฏุงูุง</span>
        </button>
        
        <button className="flex flex-col items-center text-emerald-400 py-1">
          <Crown className="h-6 w-6" />
          <span className="text-xs mt-1">VIP</span>
        </button>
      </div>
    </div>
  );
};

export default EgyptRocketPage;